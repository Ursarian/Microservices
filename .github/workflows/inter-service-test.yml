name: Integration Tests and End-to-end Tests

on:
  push:
    branches: [ main, test ]
    paths:
      - '.github/workflows/inter-service-test.yml'
  pull_request:
    branches: [ main ]

jobs:
  inter-service-test:
    runs-on: ubuntu-latest

    steps:
    # Downloads this repository code into the GitHub Actions runner
    - name: Checkout code
      uses: actions/checkout@v3

    # Sets up Node.js environment
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install root dependencies
      run: npm install

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.6/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose version

    - name: Build and Start Services
      run: docker-compose up -d --build

    - name: Wait for user-service
      run: |
        for i in {1..10}; do
          if curl -s http://localhost:3000/api/v2/users/all; then
            echo "user-service is ready"
            break
          fi
          echo "Waiting for user-service..."
          sleep 5
        done

    - name: Wait for product-service
      run: |
        for i in {1..10}; do
          if curl -s http://localhost:3001/api/v2/products/all; then
            echo "product-service is ready"
            break
          fi
          echo "Waiting for product-service..."
          sleep 5
        done

    - name: Run all tests
      run: npx jest ./__tests__/ --detectOpenHandles --forceExit
      env:
        NODE_ENV: test